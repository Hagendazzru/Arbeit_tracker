<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë§ˆë¹„ë…¸ê¸° ì•Œë°” íƒ€ì„ë³´ë“œ</title>
  <meta name="description" content="í˜„ì¬ ì‹œê°„ ê¸°ì¤€ ê°€ëŠ¥í•œ ë§ˆë¹„ë…¸ê¸° ì•„ë¥´ë°”ì´íŠ¸ì™€ ë‹¤ìŒ íƒ€ì„ì„ ì•Œë ¤ì£¼ê³ , ì•ŒëŒë„ ì„¤ì •í•  ìˆ˜ ìˆëŠ” ë‹¨ì¼ HTML í˜ì´ì§€" />
  <style>
    :root{
      --bg:#0b0f14;--card:#111826;--muted:#6b7280;--text:#e5e7eb;--brand:#60a5fa;--ok:#34d399;--warn:#f59e0b;--bad:#ef4444;--line:#1f2937;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    a{color:var(--brand);text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    header{display:flex;flex-wrap:wrap;gap:16px;align-items:center;justify-content:space-between;margin-bottom:18px}
    .title{font-size:20px;font-weight:700}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:1.2fr 1fr;gap:16px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.2)}
    .card h2{font-size:16px;margin:0 0 10px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row > *{flex:0 0 auto}
    .grow{flex:1 1 auto}
    input, select, textarea, button{background:#0f172a;color:var(--text);border:1px solid var(--line);border-radius:10px;padding:10px 12px}
    input[type="time"]{padding:8px 10px}
    button{cursor:pointer}
    button.primary{background:var(--brand);border-color:transparent;color:#0b1220}
    button.ghost{background:transparent}
    .pill{padding:.2rem .5rem;border-radius:999px;font-size:12px;border:1px solid var(--line);color:var(--muted)}
    .ok{color:var(--ok)}.warn{color:var(--warn)}.bad{color:var(--bad)}
    .table{width:100%;border-collapse:separate;border-spacing:0}
    .table th,.table td{padding:10px 8px;border-bottom:1px dashed var(--line);vertical-align:top}
    .table th{font-weight:600;text-align:left;color:#cbd5e1}
    .nowrap{white-space:nowrap}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .label{font-size:12px;color:var(--muted)}
    .kbd{border:1px solid var(--line);background:#0b1220;padding:2px 6px;border-radius:6px;font-size:12px}
    .help{font-size:13px;color:var(--muted)}
    .footer{margin-top:18px;color:var(--muted);font-size:12px;text-align:center}
    .badge{font-size:12px;padding:3px 8px;border-radius:999px;border:1px solid var(--line);}
    .list{display:flex;flex-direction:column;gap:8px}
    .item{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px;border:1px solid var(--line);border-radius:10px;background:#0c1320}
    .item .name{font-weight:600}
    .hidden{display:none}
    details summary{cursor:pointer;color:#cbd5e1}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}
  .tl{overflow:auto}
    .tl-legend{display:flex;gap:8px;align-items:center;margin:6px 0}
    .swatch{display:inline-block;width:12px;height:12px;border-radius:3px;border:1px solid var(--line)}
    .swatch.recruit{background:#0c2e21}
    .swatch.report{background:#0d1b2a}
    .tl-table{width:100%}
    .track{position:relative;height:22px;min-width:960px;background-image:repeating-linear-gradient(to right, rgba(255,255,255,.04) 0 1px, transparent 1px 40px);border:1px solid var(--line);border-radius:8px}
    .bar{position:absolute;height:100%;border-radius:6px;opacity:.9}
    .bar.recruit{background:#34d399}
    .bar.report{background:#60a5fa}
    .tl-hours{position:relative;height:20px;min-width:960px;margin-bottom:6px}
    .tl-hours .tick{position:absolute;top:0;transform:translateX(-50%);font-size:11px;color:#94a3b8}
    .nowline{position:absolute;top:0;bottom:0;width:2px;background:var(--warn);opacity:.95;box-shadow:0 0 0 1px rgba(0,0,0,.25)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="row">
        <div class="title">ğŸ§­ ë§ˆë¹„ë…¸ê¸° ì•Œë°” íƒ€ì„ë³´ë“œ</div>
        <span class="chip" id="statusChip">ëŒ€ê¸°ì¤‘</span>
      </div>
      <div class="chips">
        <span class="chip">ë‹¨ì¼ HTML Â· GitHub ì—…ë¡œë“œ OK</span>
        <span class="chip">ì•ŒëŒ ì§€ì› (ë¸Œë¼ìš°ì €/ì†Œë¦¬)</span>
        <span class="chip">ë¡œì»¬ ì €ì¥</span>
        <span class="chip">KR í‘œì¤€ ê¸°ë³¸ê°’</span>
      </div>
    </header>

    <div class="grid">
      <!-- ì¢Œì¸¡: ì§€ê¸ˆ ê°€ëŠ¥í•œ ì•Œë°” / ë‹¤ìŒ íƒ€ì„ -->
      <section class="card">
        <h2>ì§€ê¸ˆ ê°€ëŠ¥í•œ ì•Œë°”</h2>
        <div class="row" style="margin-bottom:8px">
          <div class="grow">
            <div class="help">ì‹¤ì‹œê°„ ë™ê¸°í™”ëœ <strong>ë§ˆë¹„ ì‹œê°„</strong>ê³¼ ì—°ê²°ëœ ì•Œë°” ê°€ëŠ¥ ìƒíƒœë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.</div>
            <div class="help">í˜„ì¬ ì‹œê°„ <span id="nowReal" class="mono"></span> Â· ë§ˆë¹„ ì‹œê°„ <span id="nowMabi" class="mono"></span></div>
          </div>
          <div class="row">
            <label class="row" title="ë¸Œë¼ìš°ì € ì•Œë¦¼ í—ˆìš©"><input type="checkbox" id="chkNotify"> ì•Œë¦¼</label>
            <label class="row" title="íš¨ê³¼ìŒ ì¬ìƒ"><input type="checkbox" id="chkSound" checked> ì†Œë¦¬</label>
          </div>
        </div>

        <div id="activeList" class="list" aria-live="polite"></div>

        <h2 style="margin-top:16px">ë‹¤ìŒ ì•Œë°” íƒ€ì„</h2>
        <div id="upcomingList" class="list"></div>
      </section>

      <!-- ìš°ì¸¡: ì‹œê³„ ë™ê¸°í™” & í”„ë¦¬ì…‹ & ìŠ¤ì¼€ì¤„ í¸ì§‘ -->
      <aside class="card">
        <h2>ë§ˆë¹„ ì‹œê³„ ë™ê¸°í™”</h2>
        <div class="help">ë§ˆë¹„ í•˜ë£¨ = <strong>36ë¶„</strong>, 1ì‹œê°„ = <strong>90ì´ˆ</strong>. í˜„ì¬ ê²Œì„ ë‚´ ì‹œê³„ì— ë§ì¶° ë™ê¸°í™”í•˜ì„¸ìš”.</div>
        <div class="row" style="margin:8px 0">
          <label>í˜„ì¬ ë§ˆë¹„ ì‹œê°„ ì…ë ¥</label>
          <input type="time" id="syncTime" step="60" class="mono"/>
          <button class="primary" id="btnSync">ë™ê¸°í™”</button>
          <button id="btnReset">ë¦¬ì…‹</button>
        </div>
        <div class="row" style="margin:8px 0">
          <select id="presetSelect">
            <option value="kr">KR í‘œì¤€ ìŠ¤ì¼€ì¤„(ìš”ì•½)</option>
            <option value="sample">ì˜ˆì‹œ: í‹°ë¥´ ì½”ë„¤ì¼ ìƒì ë“¤</option>
            <option value="empty">ë¹ˆ ìŠ¤ì¼€ì¤„</option>
          </select>
          <button id="btnPreset">ì ìš©</button>
        </div>

        <details style="margin-top:8px">
          <summary>ìŠ¤ì¼€ì¤„ JSON í¸ì§‘</summary>
          <div class="help" style="margin:6px 0">í˜•ì‹: [{"name":"NPC","place":"ì§€ì—­","windows":[{"start":"HH:MM","end":"HH:MM","note":"ì˜µì…˜"}]}]</div>
          <textarea id="jsonArea" rows="12" style="width:100%;font-family:ui-monospace,monospace"></textarea>
          <div class="row" style="margin-top:8px">
            <button class="primary" id="btnSaveJson">ì €ì¥</button>
            <button id="btnCopyJson">ë³µì‚¬</button>
            <span class="help">ë¸Œë¼ìš°ì € <span class="kbd">localStorage</span>ì— ì €ì¥ë©ë‹ˆë‹¤.</span>
          </div>
        </details>
      </aside>
    </div>

    <section class="card" style="margin-top:16px">
      <h2>ì „ì²´ ìŠ¤ì¼€ì¤„</h2>
      <table class="table" id="tblAll">
        <thead>
          <tr>
            <th>NPC</th>
            <th>ì§€ì—­</th>
            <th>ì‹œê°„ëŒ€ (ë§ˆë¹„ ì‹œê°„)</th>
            <th class="nowrap">ìƒíƒœ</th>
            <th class="nowrap">ì•ŒëŒ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section class="card" style="margin-top:16px">
      <h2>íƒ€ì„ë¼ì¸ ë·° (ê°„íŠ¸)</h2>
      <div class="row" style="margin-bottom:8px">
        <label class="row"><input type="checkbox" id="favOnly"> ë‚´ê°€ ì§€ì •í•œ ì•Œë°”ë§Œ</label>
        <input id="filterText" placeholder="NPC/ì§€ì—­ ê²€ìƒ‰" />
        <span class="tl-legend">
          <span class="swatch recruit"></span><span class="label">ëª¨ì§‘</span>
          <span class="swatch report" style="margin-left:8px"></span><span class="label">ë³´ê³ </span>
        </span>
      </div>
      <div class="tl">
        <div id="tlHours" class="tl-hours"></div>
        <table class="table tl-table">
          <thead>
            <tr><th style="width:220px">NPC</th><th style="width:120px">ì§€ì—­</th><th style="width:80px">ì¦ê²¨ì°¾ê¸°</th><th>ì‹œê°„ëŒ€</th></tr>
          </thead>
          <tbody id="tlBody"></tbody>
        </table>
      </div>
    </section>

    <p class="footer">
      â“˜ ì´ í˜ì´ì§€ëŠ” ê³µì‹ ë°ì´í„°ê°€ ì•„ë‹Œ <strong>ì‚¬ìš©ì í¸ì§‘ ê°€ëŠ¥</strong> ìŠ¤ì¼€ì¤„ì„ ê¸°ë°˜ìœ¼ë¡œ ë™ì‘í•©ë‹ˆë‹¤. ì„œë²„/ì±„ë„/ì´ë²¤íŠ¸ì— ë”°ë¼ ì‹¤ì œ ì‹œê°„ì€ ë‹¤ë¥¼ ìˆ˜ ìˆì–´ìš”.
    </p>
  </div>

  <audio id="bell" preload="auto">
    <source src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQAAAC0ATm9pc2UgbWFkZSBieSBha2FzYWthAAAAAAACAAACcQBQAAAB//tQxAADBcQAAAgAAAACAAACcQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==" type="audio/mpeg"/>
  </audio>

  <script>
  ;(() => {
    // ===== Core time math =====
    // 1 ë§ˆë¹„ ë¶„ = 1500 ms, 1 ë§ˆë¹„ ì‹œê°„ = 90,000 ms, 1 ë§ˆë¹„ ì¼ = 2,160,000 ms (36ë¶„)
    const MS_PER_MABI_MIN = 1500;
    const MS_PER_MABI_HOUR = 60 * MS_PER_MABI_MIN; // 90,000
    const MS_PER_MABI_DAY = 24 * MS_PER_MABI_HOUR; // 2,160,000

    // ë™ê¸°í™” ì˜¤í”„ì…‹: now -> target Mabi HH:MM ìœ¼ë¡œ ë§ì¶”ëŠ” ì‹¤ìˆ˜ìš© ì˜¤í”„ì…‹(ms)
    let syncOffset = loadOffset(); // realNowMs - mabiMs(now)

    function loadOffset(){
      const v = localStorage.getItem('mabi-sync-offset');
      return v ? Number(v) : 0; // 0ì´ë©´ ì„ì˜ ê¸°ì¤€
    }
    function saveOffset(v){
      localStorage.setItem('mabi-sync-offset', String(v));
    }

    // í˜„ì¬ ë§ˆë¹„ ì‹œê°„ì„ DateLikeë¡œ ë°˜í™˜ (HH:MM)
    function getNow(){
      const now = Date.now();
      // mabiElapsedMs ëŠ” ë™ê¸°í™”ëœ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°
      const mabiElapsedMs = (now - syncOffset) % MS_PER_MABI_DAY;
      const mabiMins = Math.floor(mabiElapsedMs / MS_PER_MABI_MIN);
      const H = Math.floor(mabiMins / 60);
      const M = mabiMins % 60;
      return { now, H, M, mabiMins, mabiElapsedMs };
    }

    function fmtHM(H, M){
      const pad = n => String(n).padStart(2,'0');
      return `${pad(H)}:${pad(M)}`;
    }
    function parseHM(s){
      const m = String(s||'').match(/^(\d{1,2}):(\d{2})$/);
      if(!m) return null;
      const H = Math.min(23, Math.max(0, parseInt(m[1],10)));
      const M = Math.min(59, Math.max(0, parseInt(m[2],10)));
      return {H,M, mins: H*60+M};
    }

    // ===== Schedules =====
    const defaultData = [
      // === KR ì„œë²„ í‘œì¤€ ìŠ¤ì¼€ì¤„ (ìš”ì•½) ===
      // ê° í•­ëª©ì€ ëª¨ì§‘/ë³´ê³  ë‹¨ê³„ë¡œ ë¶„ë¦¬í–ˆìŠµë‹ˆë‹¤. (ëª¨ì§‘ êµ¬ê°„ ë â†’ ë³´ê³  ì‹œì‘)
      // --- í‹°ë¥´ ì½”ë„¤ì¼ ---
      { name: "ë”œë¦¬ìŠ¤(íëŸ¬)", place: "í‹°ë¥´ ì½”ë„¤ì¼", windows: [ { start: "06:00", end: "09:00", note: "ëª¨ì§‘" }, { start: "09:00", end: "15:00", note: "ë³´ê³ " } ] },
      { name: "ë°ì´ì•ˆ(ì¼ë°˜)", place: "í‹°ë¥´ ì½”ë„¤ì¼", windows: [ { start: "07:00", end: "09:00", note: "ëª¨ì§‘" }, { start: "09:00", end: "19:00", note: "ë³´ê³ " } ] },
      { name: "ë§ì½¤(ì¡í™”ì )", place: "í‹°ë¥´ ì½”ë„¤ì¼", windows: [ { start: "07:00", end: "09:00", note: "ëª¨ì§‘" }, { start: "09:00", end: "19:00", note: "ë³´ê³ " } ] },
      { name: "í”¼ë¥´ì•„ìŠ¤(ì—¬ê´€)", place: "í‹°ë¥´ ì½”ë„¤ì¼", windows: [ { start: "07:00", end: "09:00", note: "ëª¨ì§‘" }, { start: "09:00", end: "19:00", note: "ë³´ê³ " } ] },
      { name: "í¼ê±°ìŠ¤(ëŒ€ì¥ê°„)", place: "í‹°ë¥´ ì½”ë„¤ì¼", windows: [ { start: "12:00", end: "13:00", note: "ëª¨ì§‘" }, { start: "13:00", end: "19:00", note: "ë³´ê³ " } ] },
      { name: "ì¼€ì´í‹´(ì‹ë£Œí’ˆì )", place: "í‹°ë¥´ ì½”ë„¤ì¼", windows: [ { start: "12:00", end: "14:00", note: "ëª¨ì§‘" }, { start: "14:00", end: "21:00", note: "ë³´ê³ " } ] },
      { name: "ì—”ë¸ë¦¬ì˜¨(ì„±ë‹¹)", place: "í‹°ë¥´ ì½”ë„¤ì¼", windows: [ { start: "12:00", end: "16:00", note: "ëª¨ì§‘" }, { start: "16:00", end: "21:00", note: "ë³´ê³ " } ] },

      // --- ë˜ë°”íŠ¼ ---
      { name: "ë§ˆëˆ„ìŠ¤(íëŸ¬)", place: "ë˜ë°”íŠ¼", windows: [ { start: "06:00", end: "09:00", note: "ëª¨ì§‘" }, { start: "09:00", end: "15:00", note: "ë³´ê³ " } ] },
      { name: "ì—ë°˜(ëª¨í—˜ê°€)", place: "ë˜ë°”íŠ¼", windows: [ { start: "07:00", end: "09:00", note: "ëª¨ì§‘" }, { start: "09:00", end: "16:00", note: "ë³´ê³ " } ] },
      { name: "ë°œí„°(ì¡í™”ì )", place: "ë˜ë°”íŠ¼", windows: [ { start: "07:00", end: "09:00", note: "ëª¨ì§‘" }, { start: "09:00", end: "19:00", note: "ë³´ê³ " } ] },
      { name: "ì‹œëª¬(ì˜ë¥˜ì )", place: "ë˜ë°”íŠ¼", windows: [ { start: "07:00", end: "12:00", note: "ëª¨ì§‘" }, { start: "12:00", end: "19:00", note: "ë³´ê³ " } ] },
      { name: "ìŠ¤íŠœì–´íŠ¸(ë„ì„œê´€)", place: "ë˜ë°”íŠ¼", windows: [ { start: "09:00", end: "11:00", note: "ëª¨ì§‘" }, { start: "11:00", end: "19:00", note: "ë³´ê³ " } ] },
      { name: "ê¸€ë¦¬ë‹ˆìŠ¤(ì‹ë£Œí’ˆì )", place: "ë˜ë°”íŠ¼", windows: [ { start: "12:00", end: "14:00", note: "ëª¨ì§‘" }, { start: "14:00", end: "21:00", note: "ë³´ê³ " } ] },
      { name: "í¬ë¦¬ìŠ¤í…”(ì„±ë‹¹)", place: "ë˜ë°”íŠ¼", windows: [ { start: "12:00", end: "14:00", note: "ëª¨ì§‘" }, { start: "14:00", end: "21:00", note: "ë³´ê³ " } ] },
      { name: "ì•„ì´ë¼(ì„œì )", place: "ë˜ë°”íŠ¼", windows: [ { start: "13:00", end: "15:00", note: "ëª¨ì§‘" }, { start: "15:00", end: "20:00", note: "ë³´ê³ " } ] },
      { name: "ë„¤ë¦¬ìŠ¤(ë¬´ê¸°)", place: "ë˜ë°”íŠ¼", windows: [ { start: "15:00", end: "17:00", note: "ëª¨ì§‘" }, { start: "17:00", end: "22:00", note: "ë³´ê³ " } ] },

      // --- ì¹´ë¸Œ í•­êµ¬ ---
      { name: "ì•„ìŠ¤ì½˜(ë“±ëŒ€)", place: "ì¹´ë¸Œ í•­êµ¬", windows: [ { start: "16:00", end: "19:00", note: "ëª¨ì§‘" }, { start: "19:00", end: "22:00", note: "ë³´ê³ " } ] },

      // --- ë°˜í˜¸ë¥´ ---
      { name: "ì•„ì´ë°ë¥¸(ëŒ€ì¥ê°„)", place: "ë°˜í˜¸ë¥´", windows: [ { start: "07:00", end: "12:00", note: "ëª¨ì§‘" }, { start: "12:00", end: "19:00", note: "ë³´ê³ " } ] },
      { name: "ìˆ€(ì±„êµ´ì¥)", place: "ë°˜í˜¸ë¥´", windows: [ { start: "10:00", end: "15:00", note: "ëª¨ì§‘" }, { start: "15:00", end: "23:00", note: "ë³´ê³ " } ] },
      { name: "ì—ì¼ë Œ(ëŒ€ì¥ê°„)", place: "ë°˜í˜¸ë¥´", windows: [ { start: "12:00", end: "13:00", note: "ëª¨ì§‘" }, { start: "13:00", end: "19:00", note: "ë³´ê³ " } ] },
      { name: "ì»´ê±´(ì„±ë‹¹)", place: "ë°˜í˜¸ë¥´", windows: [ { start: "12:00", end: "16:00", note: "ëª¨ì§‘" }, { start: "16:00", end: "21:00", note: "ë³´ê³ " } ] },

      // --- ì´ë©˜ ë§ˆí•˜ ---
      { name: "ì•„ê·¸ë„¤ìŠ¤(íëŸ¬)", place: "ì´ë©˜ ë§ˆí•˜", windows: [ { start: "06:00", end: "09:00", note: "ëª¨ì§‘" }, { start: "09:00", end: "15:00", note: "ë³´ê³ " } ] },
      { name: "ê°ˆë¹ˆ(ì¡í™”ì )", place: "ì´ë©˜ ë§ˆí•˜", windows: [ { start: "07:00", end: "09:00", note: "ëª¨ì§‘" }, { start: "09:00", end: "19:00", note: "ë³´ê³ " } ] },
      { name: "ì—˜ë ˆë…¸ì•„(ì˜ë¥˜ì )", place: "ì´ë©˜ ë§ˆí•˜", windows: [ { start: "07:00", end: "09:00", note: "ëª¨ì§‘" }, { start: "09:00", end: "19:00", note: "ë³´ê³ " } ] },
      { name: "ë ˆë¦¬(ì¸í˜•ê³µë°©)", place: "ì´ë©˜ ë§ˆí•˜", windows: [ { start: "07:00", end: "16:00", note: "ëª¨ì§‘" }, { start: "16:00", end: "19:00", note: "ë³´ê³ " } ] },
      { name: "ë¸(ê½ƒê°€ê²Œ)", place: "ì´ë©˜ ë§ˆí•˜", windows: [ { start: "08:00", end: "10:00", note: "ëª¨ì§‘" }, { start: "10:00", end: "16:00", note: "ë³´ê³ " } ] },
      { name: "ë„¤ì¼(ìŒì•…ìƒì )", place: "ì´ë©˜ ë§ˆí•˜", windows: [ { start: "10:00", end: "12:00", note: "ëª¨ì§‘" }, { start: "12:00", end: "15:00", note: "ë³´ê³ " } ] },
      { name: "í”„ë ˆì´ì €(ì‹ë£Œí’ˆì )", place: "ì´ë©˜ ë§ˆí•˜", windows: [ { start: "12:00", end: "14:00", note: "ëª¨ì§‘" }, { start: "14:00", end: "21:00", note: "ë³´ê³ " } ] },
      { name: "ì œì„ìŠ¤(ì„±ë‹¹)", place: "ì´ë©˜ ë§ˆí•˜", windows: [ { start: "12:00", end: "14:00", note: "ëª¨ì§‘" }, { start: "14:00", end: "21:00", note: "ë³´ê³ " } ] },
      { name: "ì˜¤ìŠ¬ë¼(ë¬´ê¸°ì )", place: "ì´ë©˜ ë§ˆí•˜", windows: [ { start: "15:00", end: "17:00", note: "ëª¨ì§‘" }, { start: "17:00", end: "22:00", note: "ë³´ê³ " } ] },

      // --- íƒˆí‹´ ---
      { name: "í”¼ì—ë¦­(ì¡í™”ì )", place: "íƒˆí‹´", windows: [ { start: "07:00", end: "09:00", note: "ëª¨ì§‘" }, { start: "09:00", end: "19:00", note: "ë³´ê³ " } ] },
      { name: "ë¸Œë Œë‹¤(ì˜ë¥˜ì )", place: "íƒˆí‹´", windows: [ { start: "07:00", end: "09:00", note: "ëª¨ì§‘" }, { start: "09:00", end: "19:00", note: "ë³´ê³ " } ] },
      { name: "ì•„ì´ë°”(ì—°ê¸ˆìˆ ì‚¬ì˜ ì§‘)", place: "íƒˆí‹´", windows: [ { start: "10:00", end: "14:00", note: "ëª¨ì§‘" }, { start: "14:00", end: "21:00", note: "ë³´ê³ " } ] },
      { name: "ì½œí—¨(ì„±ë‹¹)", place: "íƒˆí‹´", windows: [ { start: "12:00", end: "14:00", note: "ëª¨ì§‘" }, { start: "14:00", end: "21:00", note: "ë³´ê³ " } ] },

      // --- íƒ€ë¼ ---
      { name: "í•œìŠ¤(í™”ê°€)", place: "íƒ€ë¼", windows: [ { start: "07:00", end: "09:00", note: "ëª¨ì§‘" }, { start: "09:00", end: "16:00", note: "ë³´ê³ " } ] },
      { name: "í‚¤ì´ìŠ¤(ì€í–‰)", place: "íƒ€ë¼", windows: [ { start: "07:00", end: "09:00", note: "ëª¨ì§‘" }, { start: "09:00", end: "23:00", note: "ë³´ê³ " } ] },
      { name: "ì½”ë Œí‹´(ë²•í™©ì²­)", place: "íƒ€ë¼", windows: [ { start: "09:00", end: "14:00", note: "ëª¨ì§‘" }, { start: "14:00", end: "20:00", note: "ë³´ê³ " } ] },
      { name: "ë¦¬ë¦¬ìŠ¤(ë§ˆì°½ëŒ€íšŒì¥)", place: "íƒ€ë¼", windows: [ { start: "10:00", end: "15:00", note: "ëª¨ì§‘" }, { start: "15:00", end: "21:00", note: "ë³´ê³ " } ] }
    ];

    const presets = {
      kr: structuredClone(defaultData),
      sample: [
        { name: "ë”œë¦¬ìŠ¤(íëŸ¬)", place: "í‹°ë¥´ ì½”ë„¤ì¼", windows: [ { start: "08:00", end: "12:00", note: "ì˜ˆì‹œ: ì¹˜ë£Œë¶€" }, { start: "18:00", end: "21:00", note: "ì˜ˆì‹œ: ë³´ì¶©" } ] },
        { name: "ë§ì½¤(ì¡í™”ì )", place: "í‹°ë¥´ ì½”ë„¤ì¼", windows: [ { start: "09:00", end: "11:00", note: "ì˜ˆì‹œ" }, { start: "15:00", end: "17:30", note: "ì˜ˆì‹œ" } ] },
        { name: "ì¹´ì´í‹´(ì‹ë‹¹)", place: "í‹°ë¥´ ì½”ë„¤ì¼", windows: [ { start: "12:00", end: "14:00", note: "ì˜ˆì‹œ: ì£¼ë°©" }, { start: "20:00", end: "23:00", note: "ì˜ˆì‹œ" } ] }
      ],
      empty: []
    };

    function loadSchedules(){
      try {
        const raw = localStorage.getItem('mabi-parttime-schedules');
        if(!raw) return structuredClone(defaultData);
        const json = JSON.parse(raw);
        if(!Array.isArray(json)) throw new Error('bad json');
        return json;
      } catch(e){
        console.warn('ìŠ¤ì¼€ì¤„ ë¡œë”© ì‹¤íŒ¨', e);
        return structuredClone(defaultData);
      }
    }
    function saveSchedules(arr){
      localStorage.setItem('mabi-parttime-schedules', JSON.stringify(arr));
    }

    let schedules = loadSchedules();

    // ===== UI refs =====
    const elNowReal = document.getElementById('nowReal');
    const elNowMabi = document.getElementById('nowMabi');
    const elActiveList = document.getElementById('activeList');
    const elUpcomingList = document.getElementById('upcomingList');
    const elStatusChip = document.getElementById('statusChip');
    const elSyncTime = document.getElementById('syncTime');
    const elBtnSync = document.getElementById('btnSync');
    const elBtnReset = document.getElementById('btnReset');
    const elPreset = document.getElementById('presetSelect');
    const elBtnPreset = document.getElementById('btnPreset');
    const elJsonArea = document.getElementById('jsonArea');
    const elBtnSaveJson = document.getElementById('btnSaveJson');
    const elBtnCopyJson = document.getElementById('btnCopyJson');
    const elTblAll = document.querySelector('#tblAll tbody');
    const chkNotify = document.getElementById('chkNotify');
    const chkSound = document.getElementById('chkSound');
    const bell = document.getElementById('bell');
    const elTlBody = document.getElementById('tlBody');
    const elTlHours = document.getElementById('tlHours');
    const elFavOnly = document.getElementById('favOnly');
    const elFilterText = document.getElementById('filterText');

    // ===== Notifications =====
    chkNotify.addEventListener('change', async () => {
      if(chkNotify.checked && 'Notification' in window){
        if(Notification.permission === 'default'){
          try{ await Notification.requestPermission(); }catch{}
        }
      }
    });

    function notify(title, body){
      let shown=false;
      if(chkNotify && chkNotify.checked && 'Notification' in window){
        if(Notification.permission === 'default'){
          try{ Notification.requestPermission(); }catch{}
        }
        if(Notification.permission === 'granted'){
          try{ new Notification(title, { body }); shown=true; }catch{}
        }
      }
      if(chkSound && chkSound.checked){ try{ bell.currentTime = 0; bell.play(); }catch{} }
      if(!shown){ toast(`${title} Â· ${body||''}`.trim()); }
    }

    // ===== Active / Upcoming calculation =====
    function isActive(nowMins, fromMins, toMins){
      // [from, to) ë²”ìœ„, ìì • ê±¸ì¹¨ ì²˜ë¦¬
      if(fromMins <= toMins) return nowMins >= fromMins && nowMins < toMins;
      return (nowMins >= fromMins) || (nowMins < toMins);
    }

    function nextDeltaMs(nowMins, targetMins){
      let deltaMabiMins = (targetMins - nowMins);
      while(deltaMabiMins <= 0) deltaMabiMins += 24*60;
      return deltaMabiMins * MS_PER_MABI_MIN; // real ms
    }

    function buildAllRows(){
      elTblAll.innerHTML = '';
      const { mabiMins } = getNow();
      schedules.forEach((npc, idx) => {
        const activeWindows = [];
        const upcoming = [];
        npc.windows.forEach(w => {
          const s = parseHM(w.start); const e = parseHM(w.end);
          if(!s||!e) return;
          const act = isActive(mabiMins, s.mins, e.mins);
          if(act) activeWindows.push(w);
          else upcoming.push({w, delta: nextDeltaMs(mabiMins, s.mins)});
        });
        upcoming.sort((a,b)=>a.delta-b.delta);
        const soon = upcoming[0];
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><div class="name">${escapeHTML(npc.name)}</div></td>
          <td>${escapeHTML(npc.place||'')}</td>
          <td>${npc.windows.map(w=>`<span class="mono">${w.start}â€“${w.end}</span>${w.note?` <span class="label">(${escapeHTML(w.note)})</span>`:''}`).join('<br>')}</td>
          <td class="nowrap">${activeWindows.length?'<span class="badge" style="border-color:transparent;background:#0c2e21;color:#34d399">ì§„í–‰ì¤‘</span>': soon? `<span class="badge">${msToHuman(soon.delta)} í›„</span>` : '<span class="badge">â€”</span>'}</td>
          <td class="nowrap">
            ${activeWindows.length? '<button class="ghost" data-alarm="now" data-idx="'+idx+'">ì¢…ë£Œ ì•ŒëŒ</button>' : soon? '<button class="ghost" data-alarm="next" data-idx="'+idx+'">ì‹œì‘ ì•ŒëŒ</button>' : ''}
          </td>
        `;
        elTblAll.appendChild(tr);
      });
    }

    // ===== Favorites & Timeline =====
    const TL_WIDTH = 960; // px
    const SCALE = TL_WIDTH / (24*60);
    function favKey(npc){ return `${npc.name}|${npc.place||''}`; }
    function loadFavs(){ try{ return JSON.parse(localStorage.getItem('mabi-favs')||'[]'); }catch{ return []; } }
    function saveFavs(arr){ localStorage.setItem('mabi-favs', JSON.stringify(arr)); }
    let favs = loadFavs();

    function renderHours(){
      elTlHours.innerHTML = '';
      for(let h=0; h<24; h++){
        const d=document.createElement('div');
        d.className='tick'; d.style.left = (h*60*SCALE)+'px'; d.textContent = String(h).padStart(2,'0');
        elTlHours.appendChild(d);
      }
      // ensure now line in header
      let nl = elTlHours.querySelector('.nowline');
      if(!nl){ nl = document.createElement('div'); nl.className='nowline'; elTlHours.appendChild(nl); }
      elTlHours.style.backgroundImage = 'repeating-linear-gradient(to right, rgba(255,255,255,.04) 0 1px, transparent 1px 40px)';
      elTlHours.style.border='1px solid var(--line)'; elTlHours.style.borderRadius='8px';
    }

    function ensureTrackNowLines(){
      const tracks = document.querySelectorAll('.track');
      tracks.forEach(t=>{
        if(!t.querySelector('.nowline')){
          const n=document.createElement('div'); n.className='nowline'; t.appendChild(n);
        }
      });
    }

    function positionNowLines(){
      const { mabiMins } = getNow();
      const left = (mabiMins * SCALE) + 'px';
      const headers = elTlHours.querySelectorAll('.nowline');
      headers.forEach(n=>{ n.style.left = left; });
      const lines = document.querySelectorAll('.track .nowline');
      lines.forEach(n=>{ n.style.left = left; });
    }

    function renderTimeline(){
      elTlBody.innerHTML = '';
      const q = (elFilterText?.value||'').trim().toLowerCase();
      const onlyFav = !!(elFavOnly && elFavOnly.checked);
      const rows = schedules.filter(npc => {
        const matchText = !q || npc.name.toLowerCase().includes(q) || (npc.place||'').toLowerCase().includes(q);
        const matchFav = !onlyFav || favs.includes(favKey(npc));
        return matchText && matchFav;
      });
      const { mabiMins } = getNow();
      rows.forEach((npc, idx) => {
        const tr=document.createElement('tr');
        const favOn = favs.includes(favKey(npc));
        const star = favOn ? 'â˜…' : 'â˜†';
        const tdTrack = document.createElement('td');
        tdTrack.colSpan=1; tdTrack.innerHTML = `<div class=\"track\" data-track=\"1\"></div>`;
        tr.innerHTML = `<td><div class=\"name\">${escapeHTML(npc.name)}</div></td>
                        <td>${escapeHTML(npc.place||'')}</td>
                        <td class=\"nowrap\"><button class=\"ghost\" data-fav=\"${escapeHTML(favKey(npc))}\">${star} ì¦ê²¨ì°¾ê¸°</button></td>`;
        tr.appendChild(tdTrack);
        elTlBody.appendChild(tr);
        const track = tdTrack.querySelector('.track');
        track.style.width = TL_WIDTH+'px';
        npc.windows.forEach(w=>{
          const s=parseHM(w.start); const e=parseHM(w.end); if(!s||!e) return;
          let start=s.mins, end=e.mins; if(end<start) end+=24*60; // wrap
          const left = start*SCALE; const width=(end-start)*SCALE;
          const bar=document.createElement('div');
          const active=isActive(mabiMins, s.mins, e.mins);
          bar.className = 'bar ' + (w.note&&w.note.includes('ëª¨ì§‘')? 'recruit':'report');
          bar.style.left = left+'px'; bar.style.width = Math.max(2,width)+'px';
          bar.title = `${w.start}â€“${w.end} ${w.note||''}` + (active? ' Â· ì§„í–‰ì¤‘':'');
          track.appendChild(bar);
        });
      });
      // ensure per-track now lines and position them
      ensureTrackNowLines();
      positionNowLines();
    }

    if(elFavOnly) elFavOnly.addEventListener('change', renderTimeline);
    if(elFilterText) elFilterText.addEventListener('input', ()=>{ renderTimeline(); });

    // prime audio on first user interaction
    document.addEventListener('click', ()=>{ try{ bell.play().then(()=>{ bell.pause(); bell.currentTime=0; }).catch(()=>{}); }catch{} }, { once:true });
    document.addEventListener('click', (e)=>{
      const b = e.target.closest('button[data-fav]');
      if(!b) return;
      const key = b.getAttribute('data-fav');
      if(!key) return;
      const i = favs.indexOf(key);
      if(i>=0) favs.splice(i,1); else favs.push(key);
      saveFavs(favs);
      renderTimeline();
    });

    function renderPanels(){
      const now = new Date();
      const { H, M, mabiMins } = getNow();
      elNowReal.textContent = now.toLocaleString();
      elNowMabi.textContent = fmtHM(H,M);

      // Active list
      elActiveList.innerHTML = '';
      const activeItems = [];
      schedules.forEach((npc, idx) => {
        npc.windows.forEach(w => {
          const s = parseHM(w.start); const e = parseHM(w.end);
          if(!s||!e) return;
          if(isActive(mabiMins, s.mins, e.mins)){
            const leftMs = nextDeltaMs(mabiMins, e.mins);
            activeItems.push({ npc, w, leftMs, idx });
          }
        });
      });
      activeItems.sort((a,b)=>a.leftMs - b.leftMs);
      if(activeItems.length===0){
        elActiveList.innerHTML = `<div class="item"><div>í˜„ì¬ ì§„í–‰ì¤‘ì¸ ì•Œë°”ê°€ ì—†ìŠµë‹ˆë‹¤.</div><div class="muted">ê°€ê¹Œìš´ íƒ€ì„ì€ ì•„ë˜ì—ì„œ í™•ì¸í•˜ì„¸ìš”.</div></div>`;
      } else {
        for(const it of activeItems){
          const div = document.createElement('div');
          div.className = 'item';
          div.innerHTML = `
            <div>
              <div class="name">${escapeHTML(it.npc.name)} <span class="label">@ ${escapeHTML(it.npc.place||'')}</span></div>
              <div class="help mono">${it.w.start}â€“${it.w.end} Â· ì¢…ë£Œê¹Œì§€ ${msToHuman(it.leftMs)}</div>
              ${it.w.note?`<div class="help">${escapeHTML(it.w.note)}</div>`:''}
            </div>
            <div class="row">
              <button class="ghost" data-alarm="nowEnd" data-idx="${it.idx}" data-start="${it.w.start}" data-end="${it.w.end}">ì¢…ë£Œ ì•ŒëŒ</button>
            </div>
          `;
          elActiveList.appendChild(div);
        }
      }

      // Upcoming list (soonest one per NPC)
      const soonItems = [];
      schedules.forEach((npc, idx) => {
        let soon=null;
        npc.windows.forEach(w => {
          const s = parseHM(w.start); const e = parseHM(w.end);
          if(!s||!e) return;
          if(!isActive(mabiMins, s.mins, e.mins)){
            const delta = nextDeltaMs(mabiMins, s.mins);
            if(!soon || delta < soon.delta) soon = { npc, w, delta, idx };
          }
        });
        if(soon) soonItems.push(soon);
      });
      soonItems.sort((a,b)=>a.delta-b.delta);
      elUpcomingList.innerHTML = '';
      if(soonItems.length===0){
        elUpcomingList.innerHTML = `<div class="item"><div>ì˜ˆì •ëœ ì•Œë°” íƒ€ì„ì´ ì—†ìŠµë‹ˆë‹¤.</div></div>`;
      } else {
        for(const it of soonItems.slice(0,6)){
          const div = document.createElement('div');
          div.className = 'item';
          div.innerHTML = `
            <div>
              <div class="name">${escapeHTML(it.npc.name)} <span class="label">@ ${escapeHTML(it.npc.place||'')}</span></div>
              <div class="help mono">${it.w.start} ì‹œì‘ Â· ${msToHuman(it.delta)} í›„</div>
              ${it.w.note?`<div class="help">${escapeHTML(it.w.note)}</div>`:''}
            </div>
            <div class="row">
              <button class="ghost" data-alarm="nextStart" data-idx="${it.idx}" data-start="${it.w.start}">ì‹œì‘ ì•ŒëŒ</button>
            </div>
          `;
          elUpcomingList.appendChild(div);
        }
      }

      buildAllRows();
      renderHours();
      renderTimeline();
      positionNowLines();
    }

    // ===== Alarms =====
    const timers = new Set();
    function clearTimers(){ for(const t of timers){ clearTimeout(t); timers.delete(t);} }

    function scheduleAlarm(kind, npcIdx, start, end){
      const { mabiMins } = getNow();
      const npc = schedules[npcIdx];
      const s = parseHM(start); const e = end? parseHM(end): null;
      let targetMs = 0; let label='';
      if(kind==='nextStart'){
        targetMs = nextDeltaMs(mabiMins, s.mins);
        label = `${npc.name} ì•Œë°” ì‹œì‘ (${start})`;
      } else if(kind==='nowEnd'){
        targetMs = nextDeltaMs(mabiMins, e.mins);
        label = `${npc.name} ì•Œë°” ì¢…ë£Œ (${end})`;
      } else if(kind==='next'){
        targetMs = nextDeltaMs(mabiMins, s.mins);
        label = `${npc.name} ì•Œë°” ì‹œì‘ (${start})`;
      } else if(kind==='now'){
        targetMs = nextDeltaMs(mabiMins, e.mins);
        label = `${npc.name} ì•Œë°” ì¢…ë£Œ (${end})`;
      }
      const realMs = Math.max(0, Math.floor(targetMs));
      const t = setTimeout(()=>{
        notify('â° ì•ŒëŒ', label);
      }, realMs);
      timers.add(t);
      toast(`ì•ŒëŒ ì„¤ì •ë¨ Â· ${msToHuman(realMs)} í›„: ${label}`);
    }

    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('button');
      if(!btn) return;
      if(btn.dataset.alarm){
        const kind = btn.dataset.alarm;
        const idx = Number(btn.dataset.idx);
        const start = btn.dataset.start || firstStartOf(idx);
        const end = btn.dataset.end || firstEndOf(idx);
        scheduleAlarm(kind, idx, start, end);
      }
    });

    function firstStartOf(idx){
      const w = schedules[idx]?.windows?.[0];
      return w? w.start : '00:00';
    }
    function firstEndOf(idx){
      const w = schedules[idx]?.windows?.[0];
      return w? w.end : '00:00';
    }

    // ===== Sync & Presets & JSON =====
    elBtnSync && elBtnSync.addEventListener('click', ()=>{
      const v = parseHM(elSyncTime.value);
      if(!v){ toast('HH:MM í˜•íƒœë¡œ ì…ë ¥í•˜ì„¸ìš”.'); return; }
      const now = Date.now();
      // now - offset -> mabiElapsedMs â‰¡ v.mins
      // (now - offset) % MS_PER_MABI_DAY = v.mins * 1500
      // offset = now - (v.mins*1500) (mod day)
      const desired = v.mins * MS_PER_MABI_MIN;
      // í˜„ì¬ remainder
      const remainder = (now - syncOffset) % MS_PER_MABI_DAY;
      const delta = remainder - desired; // ìš°ë¦¬ê°€ ë¹¼ì•¼í•  ì˜¤ì°¨
      syncOffset = syncOffset + delta; // ë³´ì •
      saveOffset(syncOffset);
      toast('ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
      renderPanels();
    });

    elBtnReset && elBtnReset.addEventListener('click', ()=>{
      syncOffset = 0; saveOffset(0);
      toast('ë™ê¸°í™” ë¦¬ì…‹ë¨ (ê¸°ë³¸ ê³„ì‚° ì‚¬ìš©)');
      renderPanels();
    });

    elBtnPreset.addEventListener('click', ()=>{
      const key = elPreset.value;
      if(!key) return;
      schedules = structuredClone(presets[key]||[]);
      saveSchedules(schedules);
      elJsonArea.value = JSON.stringify(schedules, null, 2);
      toast('í”„ë¦¬ì…‹ ì ìš©ë¨');
      renderPanels();
    });

    elBtnSaveJson.addEventListener('click', ()=>{
      try{
        const j = JSON.parse(elJsonArea.value||'[]');
        if(!Array.isArray(j)) throw new Error('not array');
        schedules = j;
        saveSchedules(schedules);
        toast('ìŠ¤ì¼€ì¤„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        renderPanels();
      }catch(e){ toast('JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'); }
    });

    elBtnCopyJson.addEventListener('click', async ()=>{
      try{
        await navigator.clipboard.writeText(elJsonArea.value);
        toast('í´ë¦½ë³´ë“œì— ë³µì‚¬ë¨');
      }catch{ toast('ë³µì‚¬ ì‹¤íŒ¨'); }
    });

    function escapeHTML(s){
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    }

    function msToHuman(ms){
      const sec = Math.round(ms/1000);
      if(sec < 60) return `${sec}ì´ˆ`;
      const m = Math.floor(sec/60); const s = sec%60;
      if(m < 60) return s? `${m}ë¶„ ${s}ì´ˆ` : `${m}ë¶„`;
      const h = Math.floor(m/60); const mm = m%60;
      return mm? `${h}ì‹œê°„ ${mm}ë¶„` : `${h}ì‹œê°„`;
    }

    // simple toast
    let toastTimer=null; const toastDiv = document.createElement('div');
    function ensureToast(){
      toastDiv.style.position='fixed';toastDiv.style.left='50%';toastDiv.style.bottom='24px';toastDiv.style.transform='translateX(-50%)';toastDiv.style.zIndex='9999';
      toastDiv.style.background='#0b1220';toastDiv.style.color='var(--text)';toastDiv.style.padding='10px 14px';toastDiv.style.border='1px solid var(--line)';toastDiv.style.borderRadius='10px';toastDiv.style.boxShadow='0 10px 30px rgba(0,0,0,.35)';
      toastDiv.style.display='none';document.body.appendChild(toastDiv);
    }
    function toast(msg){
      if(!toastDiv.parentNode) ensureToast();
      toastDiv.textContent = msg; toastDiv.style.display='block';
      clearTimeout(toastTimer); toastTimer = setTimeout(()=> toastDiv.style.display='none', 2500);
    }

    // init JSON area
    elJsonArea.value = JSON.stringify(schedules, null, 2);

    // status chip heartbeat
    function setStatus(){
      const { H, M } = getNow();
      elStatusChip.textContent = `ë§ˆë¹„ ${fmtHM(H,M)}`;
    }

    // tick
    function tick(){
      setStatus();
      renderPanels();
    }

    // start
    tick();
    setInterval(()=>{ setStatus(); }, 1000); // chip ì´ˆë‹¨ìœ„ ê°±ì‹ 
    setInterval(()=>{ renderPanels(); }, 5000);
    setInterval(()=>{ renderTimeline(); }, 5000); // íŒ¨ë„ 5ì´ˆ ê°±ì‹  (ì„±ëŠ¥ ì ˆì¶©)
    setInterval(()=>{ positionNowLines(); }, 500); // í˜„ì¬ ì‹œê° ë¼ì¸ ì´ë™ // íŒ¨ë„ 5ì´ˆ ê°±ì‹  (ì„±ëŠ¥ ì ˆì¶©)

  })();
  </script>
</body>
</html>
